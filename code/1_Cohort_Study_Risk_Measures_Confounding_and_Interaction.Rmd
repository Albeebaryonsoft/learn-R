---
title: "1_Cohort_Study_Risk_Measures_Confounding_and_Interaction"
output: html_document
knitr:
  opts_knit:
    setwd: '..'
---

```{r prepare-data, message=FALSE, warning=FALSE, echo=FALSE, include=FALSE}

# -------------------------------------------------
# Chunk: prepare-data-for-rr
# Goal:
#   Create a clean analysis dataset (data_for_rr)
#   with only the variables needed for RR, stratified RR,
#   and interaction analysis.
#
#   Keeps: sex, age_grp, smoke, chd
#   Removes: rows with missing values
#
# Output:
#   data_for_rr (tibble)
#   - sex: Female / Male
#   - age_grp: age groups like [0,45), [45,60), [60,+)
#   - smoke: No / Yes
#   - chd: No / Yes
# -------------------------------------------------

knitr::opts_knit$set(root.dir = "..")
setwd("..")

required_packages <- c("tidyverse", "broom", "epiR", "epitools", "gtsummary", "readr","sandwich","lmtest")
to_install <- setdiff(required_packages, rownames(installed.packages()))
if (length(to_install) > 0) {
  install.packages(to_install)
}

invisible(lapply(required_packages, library, character.only = TRUE))

dat0 <- readr::read_csv("data/framingham_raw.csv")


## =====数据清洗：选择具体的列进行清洗===== 
dat <- dat0 %>%
  mutate(
    smoke   = factor(currentSmoker, levels = c(0,1), labels = c("No","Yes")),
    chd     = factor(TenYearCHD,     levels = c(0,1), labels = c("No","Yes")),
    sex     = factor(male,           levels = c(0,1), labels = c("Female","Male")),
    diab    = factor(diabetes,       levels = c(0,1), labels = c("No","Yes")),
    hyp     = factor(prevalentHyp,   levels = c(0,1), labels = c("No","Yes")),
    age_grp = cut(age, breaks = c(0,45,60,120), right = FALSE,
                  labels = c("[0,45)","[45,60)","[60,+)"))
  )

glimpse(dat)


# ==== 数据预览：仅保留本分析所需变量的完整观测 ====
vars_use <- c("smoke","chd","sex","diab","hyp","age_grp","age","sysBP","diaBP","totChol","glucose","education","BPMeds","cigsPerDay","BMI","heartRate")
dat1 <- dat %>% select(any_of(vars_use)) %>% drop_na(smoke, chd, sex, age_grp)

```

```{r contingency-table, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# -------------------------------------------------
# Chunk: contingency-table
# Goal:
#   Present the overall 2×2 contingency table of
#   smoking (exposure) vs. 10-year CHD (outcome),
#   and report corresponding RR, RD, and OR
#   based on cohort-style risk calculations.
#
# Output:
#   - Table 1: Contingency table (counts)
#   - Table 2: Risk ratio (RR), risk difference (RD), odds ratio (OR)
# -------------------------------------------------

# --- 1. Construct 2×2 contingency table
tab_overall <- table(dat1$smoke, dat1$chd)
tab_overall

# Display the table nicely
knitr::kable(
  as.data.frame.matrix(tab_overall),
  caption = "Table 1. Overall 2×2 contingency table: Smoking vs. 10-year CHD",
  align = "c"
)

# --- 2. Estimate RR / RD / OR using epiR
library(epiR)
e_overall <- epiR::epi.2by2(tab_overall,
                            method = "cohort.count",
                            conf.level = 0.95,
                            units = 100,
                            outcome = "as.columns")
e_overall

# 提取主要指标
rr_overall <- e_overall$massoc.summary[e_overall$massoc.summary$var == "Inc risk ratio", c("est","lower","upper")]
or_overall <- e_overall$massoc.summary[e_overall$massoc.summary$var == "Inc odds ratio", c("est","lower","upper")]
rd_overall <- e_overall$massoc.summary[e_overall$massoc.summary$var == "Attrib inc risk *", c("est","lower","upper")]

knitr::kable(rr_overall, caption = "Table 2a. Risk Ratio (RR)", digits = 3)
knitr::kable(rd_overall, caption = "Table 2b. Risk Difference (RD)", digits = 3)
knitr::kable(or_overall, caption = "Table 2c. Odds Ratio (OR)", digits = 3)

```

```{r stratification-gender-age, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# -------------------------------------------------
# Chunk: stratification-gender-age
# Goal:
#   (1) Estimate stratum-specific Risk Ratios (RR)
#       for smoking -> CHD by sex and by age group.
#       These will later feed into forest plots.
#
#   (2) Compute Mantel–Haenszel (MH) common OR
#       to assess confounding / consistency across strata.
#
# Output shown in report:
#   - Table 3. Sex-stratified RR (smoking vs CHD)
#   - Table 4. Age-stratified RR (smoking vs CHD)
#   - Table 5. Mantel–Haenszel common ORs
#
# Notes:
#   * RR (risk ratio) is what we care about biologically.
#   * MH OR is used here to summarize across strata
#     and to assess confounding (esp. age).
# -------------------------------------------------

# Helper: compute RR within each stratum
calc_rr_by_stratum <- function(df, strata_var){
  df %>%
    dplyr::group_by(.data[[strata_var]]) %>%
    dplyr::group_modify(~{
      # 2x2 within this stratum
      tt <- table(.x$smoke, .x$chd)

      # cohort.count gives risks and risk ratio
      e  <- epiR::epi.2by2(
        tt,
        method     = "cohort.count",
        conf.level = 0.95,
        units      = 100,
        outcome    = "as.columns"
      )

      # pull RR row
      rr_row <- e$massoc.summary[
        e$massoc.summary$var == "Inc risk ratio",
        c("est", "lower", "upper")
      ]

      tibble::tibble(
        est   = rr_row$est,
        lcl   = rr_row$lower,
        ucl   = rr_row$upper,
        N_stratum = nrow(.x)
      )
    }) %>%
    dplyr::rename(Stratum = !!strata_var,
                  RR = est,
                  `95% LCL` = lcl,
                  `95% UCL` = ucl)
}

# 1) Sex-stratified RR
rr_by_sex <- calc_rr_by_stratum(dat1, "sex")

# 2) Age-stratified RR
rr_by_age <- calc_rr_by_stratum(dat1, "age_grp")

# ---- Present tables for RR ----
knitr::kable(
  rr_by_sex,
  digits = 3,
  caption = "Table 3. Sex-stratified Risk Ratios (RR) for smoking and 10-year CHD"
)

knitr::kable(
  rr_by_age,
  digits = 3,
  caption = "Table 4. Age-stratified Risk Ratios (RR) for smoking and 10-year CHD"
)


# ---- Mantel–Haenszel common ORs ----
# Sex as stratifier
tab_3d_sex <- xtabs(~ smoke + chd + sex, data = dat1)
mh_sex <- mantelhaen.test(tab_3d_sex)

# Age group as stratifier
tab_3d_age <- xtabs(~ smoke + chd + age_grp, data = dat1)
mh_age <- mantelhaen.test(tab_3d_age)

mh_out <- tibble::tibble(
  Strata      = c("Sex", "Age group"),
  MH_common_OR = c(unname(mh_sex$estimate), unname(mh_age$estimate)),
  p_value      = c(mh_sex$p.value,          mh_age$p.value)
)

knitr::kable(
  mh_out,
  digits = 3,
  caption = "Table 5. Mantel–Haenszel common ORs (controlling for sex or age group)"
)

```

```{r evaluate-confounding, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# -------------------------------------------------
# Chunk: evaluate-confounding
# Goal:
#   Assess confounding by comparing crude vs adjusted
#   risk ratios (RR) for smoking → CHD.
#
# Methods:
#   - Modified Poisson regression with robust SE (for RR)
#   - Compare crude and age/diabetes/hypertension-adjusted models
#   - Quantify % change to identify confounding
#
# Output shown in report:
#   - Table 6. Crude and adjusted RR for smoking
#   - Text summary of % change
# -------------------------------------------------

# --- 1) Libraries
library(sandwich)
library(lmtest)
library(broom)

# --- 2) Crude RR (modified Poisson)
fit_crude <- glm(as.numeric(chd) - 1 ~ smoke,
                 family = poisson(link = "log"),
                 data = dat1)

vc_crude  <- sandwich::vcovHC(fit_crude, type = "HC0")

crude_res <- lmtest::coeftest(fit_crude, vcov. = vc_crude) %>%
  broom::tidy() %>%
  dplyr::mutate(
    RR  = exp(estimate),
    LCL = exp(estimate - 1.96 * std.error),
    UCL = exp(estimate + 1.96 * std.error)
  )

crude_rr <- crude_res %>%
  dplyr::filter(term == "smokeYes") %>%
  dplyr::select(RR, LCL, UCL)


# --- 3) Adjusted RR (for age group, diabetes, hypertension)
fit_adj <- glm(as.numeric(chd) - 1 ~ smoke + age_grp + diab + hyp,
               family = poisson(link = "log"),
               data = dat1)

vc_adj  <- sandwich::vcovHC(fit_adj, type = "HC0")

adj_res <- lmtest::coeftest(fit_adj, vcov. = vc_adj) %>%
  broom::tidy() %>%
  dplyr::mutate(
    RR  = exp(estimate),
    LCL = exp(estimate - 1.96 * std.error),
    UCL = exp(estimate + 1.96 * std.error)
  )

adj_rr <- adj_res %>%
  dplyr::filter(term == "smokeYes") %>%
  dplyr::select(RR, LCL, UCL)


# --- 4) Percent change to assess confounding
pct_change <- (adj_rr$RR - crude_rr$RR) / crude_rr$RR * 100


# --- 5) Display nicely in report
rr_compare <- dplyr::bind_rows(
  tibble::tibble(Model = "Crude (unadjusted)", crude_rr),
  tibble::tibble(Model = "Adjusted (age + diab + hyp)", adj_rr)
)

knitr::kable(
  rr_compare,
  digits = 3,
  caption = "Table 6. Comparison of crude and adjusted risk ratios (RR) for smoking and 10-year CHD"
)

cat(sprintf(
  "\n**Confounding assessment:** Adjusting for age, diabetes, and hypertension changed the RR by %.1f%%. ",
  pct_change
))

if (abs(pct_change) > 10) {
  cat("This exceeds the 10% threshold, indicating *substantial confounding* by these covariates.\n")
} else {
  cat("This is below the 10% threshold, suggesting minimal confounding.\n")
}

```

```{r interaction-analysis, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# -------------------------------------------------
# Chunk: interaction-analysis
# Goal:
#   Evaluate effect modification between smoking and sex
#   on 10-year CHD risk:
#     (a) Multiplicative interaction (Poisson regression + robust SE)
#     (b) Additive interaction (RERI, AP, S)
#
# Output shown in report:
#   - Table 7. Poisson model with multiplicative interaction (RRs)
#   - Table 8. Additive interaction indices (RERI, AP, S)
#   - Text interpretation of findings
# -------------------------------------------------

library(sandwich)
library(lmtest)
library(broom)
library(stringr)
library(dplyr)
library(tidyr)

# --- (a) Multiplicative interaction: Poisson + robust SE ---
fit_int <- glm(
  as.numeric(chd) - 1 ~ smoke * sex + age_grp + diab + hyp,
  family = poisson(link = "log"),
  data   = dat1
)

vc_int  <- sandwich::vcovHC(fit_int, type = "HC0")

int_res <- lmtest::coeftest(fit_int, vcov. = vc_int) %>%
  broom::tidy() %>%
  dplyr::mutate(
    RR  = exp(estimate),
    LCL = exp(estimate - 1.96 * std.error),
    UCL = exp(estimate + 1.96 * std.error)
  )

# Extract the interaction term: smokeYes × sexMale
int_interaction_term <- int_res %>%
  dplyr::filter(stringr::str_detect(term, "smokeYes:sexMale|sexMale:smokeYes")) %>%
  dplyr::select(term, RR, LCL, UCL, p.value)

knitr::kable(
  int_interaction_term,
  digits = 3,
  caption = "Table 7. Multiplicative interaction between smoking and sex (from Poisson regression)"
)


# --- (b) Additive interaction: RERI / AP / S ---
risk_cell <- dat1 %>%
  dplyr::filter(!is.na(sex), !is.na(smoke), !is.na(chd)) %>%
  dplyr::group_by(sex, smoke) %>%
  dplyr::summarise(
    n     = dplyr::n(),
    cases = sum(chd == "Yes"),
    risk  = cases / n,
    .groups = "drop"
  ) %>%
  tidyr::unite(combo, sex, smoke, sep = "_") %>%
  dplyr::select(combo, risk) %>%
  tidyr::pivot_wider(names_from = combo, values_from = risk)

# Ensure proper cells
R00 <- as.numeric(risk_cell$Female_No)
R10 <- as.numeric(risk_cell$Female_Yes)
R01 <- as.numeric(risk_cell$Male_No)
R11 <- as.numeric(risk_cell$Male_Yes)

# Compute additive interaction indices
RERI <- R11 - R10 - R01 + R00
AP   <- RERI / R11
S    <- (R11 - R00) / ((R10 - R00) + (R01 - R00))

add_int <- tibble::tibble(
  Metric = c("RERI (Relative Excess Risk due to Interaction)",
             "AP (Attributable Proportion due to Interaction)",
             "S (Synergy Index)"),
  Value = c(RERI, AP, S)
)

knitr::kable(
  add_int,
  digits = 3,
  caption = "Table 8. Additive interaction between smoking and sex (RERI, AP, S)"
)


# --- (c) Interpretation ---
cat("\n**Interpretation:**\n")

cat(sprintf(
  "• The multiplicative interaction term (smoking × sex) had RR = %.2f (95%% CI %.2f–%.2f). ",
  int_interaction_term$RR, int_interaction_term$LCL, int_interaction_term$UCL
))
if (int_interaction_term$p.value < 0.05) {
  cat("This suggests a statistically significant interaction on the multiplicative scale.\n")
} else {
  cat("This indicates no statistically significant interaction on the multiplicative scale.\n")
}

cat(sprintf(
  "• On the additive scale, RERI = %.3f, AP = %.3f, S = %.3f. ",
  RERI, AP, S
))
if (RERI > 0 & S > 1) {
  cat("These positive values indicate that the joint effect of smoking and male sex on CHD exceeds the sum of their individual effects, consistent with a *positive additive interaction*.\n")
} else {
  cat("These results suggest little or no evidence of additive interaction.\n")
}

```

```{r descriptive-table, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# -------------------------------------------------
# Chunk: descriptive-table
# Goal:
#   Create baseline descriptive statistics by smoking status.
#   This is the "Table 1" of the study — demographics and clinical characteristics
#   stratified by exposure (smoking).
#
# Output shown in report:
#   - Table 1. Baseline characteristics by smoking status
#
# Methods:
#   - Continuous vars summarized as mean (SD)
#   - Categorical vars summarized as n (%)
#   - p-values from appropriate tests (t-test / chi-squared)
# -------------------------------------------------

library(gtsummary)

desc_tbl <- dat1 %>%
  dplyr::select(smoke, sex, age, age_grp, diab, hyp, sysBP, diaBP,
                totChol, glucose, BMI, cigsPerDay) %>%
  gtsummary::tbl_summary(
    by = smoke,
    type = list(
      age ~ "continuous",
      sysBP ~ "continuous",
      diaBP ~ "continuous",
      totChol ~ "continuous",
      glucose ~ "continuous",
      BMI ~ "continuous",
      cigsPerDay ~ "continuous"
    ),
    statistic = all_continuous() ~ "{mean} ({sd})",
    missing = "ifany"
  ) %>%
  gtsummary::add_p() %>%                          # add p-values for comparison
  gtsummary::modify_header(label ~ "**Variable**") %>%
  gtsummary::bold_labels() %>%
  gtsummary::modify_caption("**Table 9. Baseline characteristics by smoking status**")

# Print as gt table (looks better in HTML/PDF)
desc_tbl %>%
  as_gt() %>%
  gt::tab_options(
    table.font.size = 11,
    heading.align = "center",
    table.align = "center",
    data_row.padding = gt::px(2)
  )

```

```{r rr-tables, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
# -------------------------------------------------
# Chunk: rr-tables
# Goal:
#   1. Create a clean analysis dataset (data_for_rr) with key variables:
#      sex, age_grp, smoke, chd.
#   2. Compute stratum-specific risk ratios (RR) for smoking → CHD
#      within levels of sex and age_grp.
#   3. Produce tables that can feed forest plots later.
#
# Output shown in report:
#   - Table 10. Sex-specific RR (smoking vs CHD)
#   - Table 11. Age-group-specific RR (smoking vs CHD)
#
# Methods:
#   For each stratum:
#     a = exposed=Yes & CHD=Yes
#     b = exposed=Yes & CHD=No
#     c = exposed=No  & CHD=Yes
#     d = exposed=No  & CHD=No
#
#     Risk_exposed   = a / (a + b)
#     Risk_unexposed = c / (c + d)
#     RR             = Risk_exposed / Risk_unexposed
#
#     SE(logRR) = sqrt( 1/a - 1/(a+b) + 1/c - 1/(c+d) )
#     95% CI    = exp( logRR ± 1.96 * SE(logRR) )
# -------------------------------------------------

library(dplyr)
library(tidyr)
library(knitr)

# --- 1) Clean analysis dataset
data_for_rr <- dat1 %>%
  dplyr::transmute(
    sex     = sex,      # Female / Male
    age_grp = age_grp,  # e.g. [0,45), [45,60), [60,+)
    smoke   = smoke,    # No / Yes
    chd     = chd       # No / Yes
  ) %>%
  dplyr::filter(
    !is.na(sex),
    !is.na(age_grp),
    !is.na(smoke),
    !is.na(chd)
  )

# --- 2a) RR stratified by sex
rr_by_sex <- data_for_rr %>%
  # Count 2×2 cells within each sex
  count(sex, smoke, chd, name = "n") %>%
  # Wide form: each sex becomes one row with 4 cells
  pivot_wider(
    names_from  = c(smoke, chd),
    values_from = n
  ) %>%
  # Compute RR and 95% CI
  mutate(
    # Cell definitions:
    a = Yes_Yes,  # smokers with CHD
    b = Yes_No,   # smokers without CHD
    c = No_Yes,   # non-smokers with CHD
    d = No_No,    # non-smokers without CHD

    risk_exp    = a / (a + b),
    risk_unexp  = c / (c + d),
    RR          = risk_exp / risk_unexp,

    logRR       = log(RR),
    SE_logRR    = sqrt(1/a - 1/(a+b) + 1/c - 1/(c+d)),
    LCL         = exp(logRR - 1.96 * SE_logRR),
    UCL         = exp(logRR + 1.96 * SE_logRR)
  ) %>%
  select(
    Stratum = sex,
    RR,
    `95% LCL` = LCL,
    `95% UCL` = UCL
  )

# --- 2b) RR stratified by age group
rr_by_age <- data_for_rr %>%
  count(age_grp, smoke, chd, name = "n") %>%
  pivot_wider(
    names_from  = c(smoke, chd),
    values_from = n
  ) %>%
  mutate(
    a = Yes_Yes,
    b = Yes_No,
    c = No_Yes,
    d = No_No,

    risk_exp    = a / (a + b),
    risk_unexp  = c / (c + d),
    RR          = risk_exp / risk_unexp,

    logRR       = log(RR),
    SE_logRR    = sqrt(1/a - 1/(a+b) + 1/c - 1/(c+d)),
    LCL         = exp(logRR - 1.96 * SE_logRR),
    UCL         = exp(logRR + 1.96 * SE_logRR)
  ) %>%
  select(
    Stratum = age_grp,
    RR,
    `95% LCL` = LCL,
    `95% UCL` = UCL
  )

# --- 3) Present both tables nicely in the report
kable(
  rr_by_sex,
  digits  = 3,
  caption = "Table 10. Sex-specific risk ratios (RR) for smoking and 10-year CHD"
)

kable(
  rr_by_age,
  digits  = 3,
  caption = "Table 11. Age-specific risk ratios (RR) for smoking and 10-year CHD"
)


```

```{r figures-smoking-chd, echo=FALSE, message=FALSE, warning=FALSE, fig.align="center", results='asis'}
# -------------------------------------------------
# Chunk: figures-smoking-chd
# Goal:
#   Create publication-style figures for:
#     Figure 1. 10-year CHD risk by smoking status
#     Figure 2. Sex-specific RR for smoking → CHD
#     Figure 3. Age-specific RR for smoking → CHD
#
# Also:
#   Save high-resolution PNGs with timestamped filenames
#   into a stable output directory.
# -------------------------------------------------

library(ggplot2)
library(dplyr)
library(scales)

# -------------------------------------------------
# Figure 1. Absolute risk of CHD by smoking status
# -------------------------------------------------

plot_dat <- dat1 %>%
  dplyr::group_by(smoke) %>%
  dplyr::summarise(
    risk = mean(chd == "Yes"),
    .groups = "drop"
  )

ymax <- min(1, max(plot_dat$risk) + 0.02)  # for nicer label spacing on bars

p1 <- ggplot(plot_dat, aes(x = smoke, y = risk)) +
  geom_col(width = 0.6) +
  geom_text(
    aes(label = scales::percent(risk, accuracy = 0.1)),
    vjust = -0.4,
    size = 4
  ) +
  labs(
    title = "Figure 1. 10-year CHD Risk by Smoking Status",
    x = NULL,
    y = "Risk (incidence proportion)"
  ) +
  ylim(0, ymax) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.title.y = element_text(face = "bold")
  )

p1 %>%
  print()


# -------------------------------------------------
# Figure 2. Forest plot of RR by sex
# -------------------------------------------------

# NOTE: use log10 scale for RR axis if you like; here we stay linear for clarity in a teaching context
p2 <- ggplot(rr_by_sex, aes(y = Stratum %||% sex, x = RR)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = `95% LCL` %||% lcl,
                     xmax = `95% UCL` %||% ucl),
                 height = 0.15,
                 linewidth = 0.8) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    title = "Figure 2. Sex-specific Risk Ratio (Smoking → CHD)",
    x = "Risk Ratio (95% CI)",
    y = "Sex"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.title.x = element_text(face = "bold")
  )

p2 %>%
  print()


# -------------------------------------------------
# Figure 3. Forest plot of RR by age group
# -------------------------------------------------

p3 <- ggplot(rr_by_age, aes(y = Stratum %||% age_grp, x = RR)) +
  geom_point(size = 3) +
  geom_errorbarh(aes(xmin = `95% LCL` %||% lcl,
                     xmax = `95% UCL` %||% ucl),
                 height = 0.15,
                 linewidth = 0.8) +
  geom_vline(xintercept = 1, linetype = "dashed") +
  labs(
    title = "Figure 3. Age-specific Risk Ratio (Smoking → CHD)",
    x = "Risk Ratio (95% CI)",
    y = "Age group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(face = "bold"),
    axis.title.x = element_text(face = "bold")
  )

p3 %>%
  print()


# -------------------------------------------------
# Export high-res figures
# -------------------------------------------------

output_dir <- file.path("..", "output", "plots_1_cohort_study")
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

timestamp <- format(Sys.time(), "%Y%m%d_%H%M")

ggplot2::ggsave(
  filename = file.path(output_dir, paste0("figure1_chd_risk_by_smoke_", timestamp, ".png")),
  plot     = p1,
  width    = 6,
  height   = 4,
  dpi      = 300
)

ggplot2::ggsave(
  filename = file.path(output_dir, paste0("figure2_rr_by_sex_", timestamp, ".png")),
  plot     = p2,
  width    = 6,
  height   = 4,
  dpi      = 300
)

ggplot2::ggsave(
  filename = file.path(output_dir, paste0("figure3_rr_by_age_", timestamp, ".png")),
  plot     = p3,
  width    = 6,
  height   = 4,
  dpi      = 300
)

cat("Figures saved to: ", normalizePath(output_dir), "\n")


```

```{r export-final-results, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}
# -------------------------------------------------
# Chunk: export-final-results
# Goal:
#   Export all key analysis outputs (tables, models, interaction metrics)
#   to a timestamped reproducibility folder.
#
# This chunk is hidden in the final report (include=FALSE)
# but it WILL run and WILL write files to disk.
#
# Files exported:
#   - rr_by_sex_<timestamp>.csv
#   - rr_by_age_<timestamp>.csv
#   - tab_overall_smoke_chd_<timestamp>.csv
#   - confounding_evaluation_<timestamp>.csv
#   - reg_crude_poisson_rb_<timestamp>.csv
#   - reg_adj_poisson_rb_<timestamp>.csv
#   - reg_poisson_interaction_<timestamp>.csv
#   - additive_interaction_<timestamp>.csv
#
# Also prints a short summary of core estimates.
# -------------------------------------------------

library(readr)
library(dplyr)
library(tibble)

# 1. Set up export directory and timestamp
output_dir <- file.path("..", "output", "final_result_1_cohort_study")
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

timestamp <- format(Sys.time(), "%Y%m%d_%H%M")


# 2. Export RR by sex (stratified)
readr::write_csv(
  rr_by_sex,
  file.path(output_dir, paste0("rr_by_sex_", timestamp, ".csv"))
)

# 3. Export RR by age group (stratified)
readr::write_csv(
  rr_by_age,
  file.path(output_dir, paste0("rr_by_age_", timestamp, ".csv"))
)

# 4. Export overall 2×2 table (smoking × CHD)
readr::write_csv(
  as.data.frame.matrix(tab_overall),
  file.path(output_dir, paste0("tab_overall_smoke_chd_", timestamp, ".csv"))
)


# 5. Export Mantel–Haenszel summary (confounding / stratified OR)
mh_out <- tibble(
  strata = c("sex", "age_grp"),
  MH_common_OR = c(unname(mh_sex$estimate), unname(mh_age$estimate)),
  p_value      = c(mh_sex$p.value,          mh_age$p.value)
)

readr::write_csv(
  mh_out,
  file.path(output_dir, paste0("confounding_evaluation_", timestamp, ".csv"))
)


# 6. Export Poisson regression models
#   (crude model, adjusted model, interaction model)
readr::write_csv(
  crude_res %>% mutate(measure = "Crude Poisson robust (RR approx)"),
  file.path(output_dir, paste0("reg_crude_poisson_rb_", timestamp, ".csv"))
)

readr::write_csv(
  adj_res %>% mutate(measure = "Adj Poisson robust (RR approx)"),
  file.path(output_dir, paste0("reg_adj_poisson_rb_", timestamp, ".csv"))
)

readr::write_csv(
  int_res %>% mutate(measure = "Poisson robust with interaction"),
  file.path(output_dir, paste0("reg_poisson_interaction_", timestamp, ".csv"))
)


# 7. Export additive interaction metrics (RERI / AP / S)
readr::write_csv(
  add_int,
  file.path(output_dir, paste0("additive_interaction_", timestamp, ".csv"))
)


# 8. Console summary for sanity check
cat("✅ 导出完成。所有结果已保存到目录:\n", normalizePath(output_dir), "\n")

cat("\n=== Overall RR (epi.2by2) ===\n")
print(rr_overall)

cat("\n=== Age-adjusted (Poisson robust) RR for smoke ===\n")
print(adj_rr)

cat(sprintf("\nConfounding %% change (Adj vs Crude RR): %.1f%%\n", pct_change))

cat("\n=== Additive interaction (Smoking × Sex; RERI / AP / S) ===\n")
print(add_int)

cat("\n文件和图像（Figures 1–3）已写入输出目录。\n")

```
