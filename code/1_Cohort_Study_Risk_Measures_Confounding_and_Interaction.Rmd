---
title: "1_Cohort_Study_Risk_Measures_Confounding_and_Interaction"
output: html_document
knitr:
  opts_knit:
    setwd: '..'
---

```{r data_prep, include=TRUE}
knitr::opts_knit$set(root.dir = "..")
setwd("..")

# ===== 安装并加载包 =====
required_packages <- c("tidyverse", "broom", "epiR", "epitools", "gtsummary", "readr","sandwich","lmtest")
to_install <- setdiff(required_packages, rownames(installed.packages()))
if (length(to_install) > 0) {
  install.packages(to_install)
}

invisible(lapply(required_packages, library, character.only = TRUE))

dat0 <- readr::read_csv("data/framingham_raw.csv")


## =====数据清洗：选择具体的列进行清洗===== 
dat <- dat0 %>%
  mutate(
    smoke   = factor(currentSmoker, levels = c(0,1), labels = c("No","Yes")),
    chd     = factor(TenYearCHD,     levels = c(0,1), labels = c("No","Yes")),
    sex     = factor(male,           levels = c(0,1), labels = c("Female","Male")),
    diab    = factor(diabetes,       levels = c(0,1), labels = c("No","Yes")),
    hyp     = factor(prevalentHyp,   levels = c(0,1), labels = c("No","Yes")),
    age_grp = cut(age, breaks = c(0,45,60,120), right = FALSE,
                  labels = c("[0,45)","[45,60)","[60,+)"))
  )

glimpse(dat)


# ==== 数据预览：仅保留本分析所需变量的完整观测 ====
vars_use <- c("smoke","chd","sex","diab","hyp","age_grp","age","sysBP","diaBP","totChol","glucose","education","BPMeds","cigsPerDay","BMI","heartRate")
dat1 <- dat %>% select(any_of(vars_use)) %>% drop_na(smoke, chd, sex, age_grp)

```

```{r contingency table, include=TRUE}
# ======================
# 1) 总体 2x2：吸烟 vs 10年CHD
# ======================
tab_overall <- table(dat1$smoke, dat1$chd)
tab_overall

# 风险、RR、RD、OR（基于计数，适合前瞻性队列）
# epiR::epi.2by2 期望2x2矩阵，"Yes"对应阳性

library(epiR)
e_overall <- epiR::epi.2by2(tab_overall,
                            method = "cohort.count",
                            conf.level = 0.95,
                            units = 100,
                            outcome = "as.columns")
e_overall

# 提取主要指标
rr_overall <- e_overall$massoc.summary[e_overall$massoc.summary$var == "Inc risk ratio", c("est","lower","upper")]
or_overall <- e_overall$massoc.summary[e_overall$massoc.summary$var == "Inc odds ratio", c("est","lower","upper")]
rd_overall <- e_overall$massoc.summary[e_overall$massoc.summary$var == "Attrib inc risk *", c("est","lower","upper")]

print(rr_overall)
print(rd_overall)
print(or_overall)

```

```{r stratification:gender and age, include=TRUE}

# ======================
# 2) 分层：按性别、年龄组
# ======================

# 2a) 按性别计算分层RR（以及森林图数据）
calc_rr_by_stratum <- function(df, strata_var){
  df %>%
    group_by(.data[[strata_var]]) %>%
    group_modify(~{
      tt <- table(.x$smoke, .x$chd)
      e  <- epiR::epi.2by2(tt, method = "cohort.count", conf.level = 0.95,
                           units = 100, outcome = "as.columns")
       rr_row <- e$massoc.summary[e$massoc.summary$var == "Inc risk ratio",
                                 c("est","lower","upper")]

      tibble(
        est = rr_row$est,
        lower = rr_row$lower,
        upper = rr_row$upper,
        n   = nrow(.x)
      )
    }) %>%
    rename(stratum = !!strata_var)
}

rr_by_sex <- calc_rr_by_stratum(dat1, "sex")
rr_by_age <- calc_rr_by_stratum(dat1, "age_grp")
rr_by_sex
rr_by_age

# 2) Mantel–Haenszel是分层版的卡方检验，体现控制混杂（如性别）的OR，不是RR

# gender stratification. result: gender is not a confounder.
tab_3d_sex <- xtabs(~ smoke + chd + sex, data = dat1)
mh_sex <- mantelhaen.test(tab_3d_sex)  # common OR
mh_sex

# age stratification. result: age is a confounder.
tab_3d_age <- xtabs(~ smoke + chd + age_grp, data = dat1)
mh_age <- mantelhaen.test(tab_3d_age)
mh_age
```

```{r evaluate confounding, include=TRUE}
# ======================
# 3) 混杂评估（以年龄为潜在混杂）
# 粗略RR vs 分层合并，用log-binomial因为不收敛non-convergence，找不到最优模型而失败
# 用Poisson代替（modified Poisson regression）
# compare: logistic vs log-binomial vs poisson+robust 
# ======================

# 3a) 粗略 RR（用Poisson稳健近似风险比）
library(sandwich); library(lmtest); library(broom)

fit_crude <- glm(as.numeric(chd) - 1 ~ smoke, family = poisson(link="log"), data = dat1)
vc_crude  <- sandwich::vcovHC(fit_crude, type = "HC0")
crude_res <- lmtest::coeftest(fit_crude, vcov. = vc_crude) %>% broom::tidy() %>%
  
  mutate(RR = exp(estimate), lcl = exp(estimate - 1.96*std.error), ucl = exp(estimate + 1.96*std.error))

crude_rr <- crude_res %>% filter(term=="smokeYes") %>% select(RR, lcl, ucl)
crude_rr

# 3b) 调整年龄、糖尿病、高血压的RR（Poisson稳健）
fit_adj <- glm(as.numeric(chd) - 1 ~ smoke + age_grp + diab + hyp, family = poisson(link="log"), data = dat1)
vc_adj  <- sandwich::vcovHC(fit_adj, type = "HC0")
adj_res <- lmtest::coeftest(fit_adj, vcov. = vc_adj) %>% broom::tidy() %>%
  mutate(RR = exp(estimate), lcl = exp(estimate - 1.96*std.error), ucl = exp(estimate + 1.96*std.error))

adj_rr <- adj_res %>% filter(term=="smokeYes") %>% select(RR, lcl, ucl)
adj_rr

# 混杂相对变化（%）
pct_change <- (adj_rr$RR - crude_rr$RR)/crude_rr$RR * 100
pct_change 

# 27.84% > 10% change compared to crude RR, strong confounding affect the relationship between exposure and outcome. 

```

```{r interaction, include=TRUE}
# ======================
# 4) interaction：吸烟*性别（乘性 & 加性）
# ======================

# 4a) 乘性交互（Poisson + robust SE）
fit_int <- glm(
  as.numeric(chd) - 1 ~ smoke * sex + age_grp + diab + hyp,
  family = poisson(link = "log"),
  data   = dat1
)

vc_int  <- sandwich::vcovHC(fit_int, type = "HC0")
int_res <- lmtest::coeftest(fit_int, vcov. = vc_int) %>%
  broom::tidy() %>%
  mutate(
    RR  = exp(estimate),
    lcl = exp(estimate - 1.96 * std.error),
    ucl = exp(estimate + 1.96 * std.error)
  )

# 把交互项（smokeYes:sexMale）提出来（有些版本会把顺序反过来成 sexMale:smokeYes，所以用 str_detect 两个都搜）
int_interaction_term <- int_res %>%
  dplyr::filter(stringr::str_detect(term, "smokeYes:sexMale|sexMale:smokeYes"))

int_interaction_term

# 4b) 加性交互（RERI / AP / S）

risk_cell <- dat1 %>%
  dplyr::filter(!is.na(sex), !is.na(smoke), !is.na(chd)) %>%      # 关键：清掉 NA，避免多行
  dplyr::group_by(sex, smoke) %>%
  dplyr::summarise(
    n     = dplyr::n(),
    cases = sum(chd == "Yes"),
    risk  = cases / n,
    .groups = "drop"
  ) %>%
  tidyr::unite(combo, sex, smoke, sep = "_") %>%                  # combo: Female_No, Female_Yes, ...
  dplyr::select(combo, risk) %>%
  tidyr::pivot_wider(names_from = combo, values_from = risk)

# 现在 risk_cell 应该有且只有这4列
R00 <- as.numeric(risk_cell$Female_No)
R10 <- as.numeric(risk_cell$Female_Yes)
R01 <- as.numeric(risk_cell$Male_No)
R11 <- as.numeric(risk_cell$Male_Yes)

# 计算相加交互指标：）
RERI <- R11 - R10 - R01 + R00              
AP   <- RERI / R11                          
S    <- (R11 - R00) / ((R10 - R00) + (R01 - R00))      
#RERI（relative excess risk due to interaction -- RERI= RR11−RR10−RR01+1 两个暴露同时存在的风险比单独的风险之和多的部分
#AP（attributable proportion due to interaction）-- AP = RERI/RR11 同时暴露的人群中，有多少比例的风险是交互造成的
#S（synergy index） --S= RR11−1/((RR10−1)+(RR01−1)) 同时暴露效应是单独效应之和的多少倍

add_int <- tibble::tibble(
  metric = c("RERI", "AP", "S"),
  value  = c(RERI,   AP,   S)
)

add_int
```

```{r descritive table, include=TRUE}
# ======================
# 5) 描述性表：按吸烟分组
# ======================
library(gtsummary)
desc_tbl <- dat1 %>%
  select(smoke, sex, age, age_grp, diab, hyp, sysBP, diaBP, totChol, glucose, BMI, cigsPerDay) %>%
  tbl_summary(by = smoke,
              type = list(age ~ "continuous", sysBP ~ "continuous", diaBP ~ "continuous",
                          totChol ~ "continuous", glucose ~ "continuous", BMI ~ "continuous", cigsPerDay ~ "continuous"),
              statistic = all_continuous() ~ "{mean} ({sd})",
              missing = "ifany") %>%
  add_p() %>%
  modify_header(label ~ "**Variable**") %>%
  bold_labels()
desc_tbl
```

```{r rr_tables, include=TRUE}

# 我们先统一准备一个干净的数据集 data_for_rr, 确保这些列存在并且是我们期望的格式
data_for_rr <- dat1 %>%
  dplyr::transmute(
    sex    = sex,                        # Female / Male
    age_grp = age_grp,                   # [0,45) etc.
    smoke  = smoke,                      # No / Yes
    chd    = chd                         # No / Yes
  ) %>%
  dplyr::filter(
    !is.na(sex),
    !is.na(age_grp),
    !is.na(smoke),
    !is.na(chd)
  )


# 性别分层：吸烟 vs CHD 的 RR
library(dplyr)
library(tidyr)

rr_by_sex <- data_for_rr %>%
  # 统计每个 sex 分层内 smoke × chd 的 2×2 计数
  count(sex, smoke, chd, name = "n") %>%
  
  # 变成宽格式：每个 sex 一行，四个格子变成四列
  pivot_wider(
    names_from = c(smoke, chd),
    values_from = n
  ) %>%
  
  # 计算RR和95%CI（Wald近似）
  mutate(
    
    a = Yes_Yes,  # a = 暴露=Yes & 结局=Yes
    b = Yes_No,   # b = 暴露=Yes & 结局=No
    c = No_Yes,   # c = 暴露=No  & 结局=Yes
    d = No_No,   # d = 暴露=No  & 结局=No

    risk_exp   = a / (a + b),   # Risk in exposed (smokers)
    risk_unexp = c / (c + d),   # Risk in unexposed (non-smokers)
    RR         = risk_exp / risk_unexp,

    logRR    = log(RR),
    SE_logRR = sqrt(1/a - 1/(a+b) + 1/c - 1/(c+d)),
    lcl      = exp(logRR - 1.96 * SE_logRR),
    ucl      = exp(logRR + 1.96 * SE_logRR)
  ) %>%
  
  # 保留画森林图需要的列
  select(
    sex,
    est = RR,
    lcl,
    ucl
  )

rr_by_sex


# 年龄分层：吸烟 vs CHD 的 RR
rr_by_age <- data_for_rr %>%
  count(age_grp, smoke, chd, name = "n") %>%
  pivot_wider(
    names_from = c(smoke, chd),
    values_from = n
  ) %>%
  mutate(
    a = Yes_Yes,
    b = Yes_No,
    c = No_Yes,
    d = No_No,

    risk_exp   = a / (a + b),
    risk_unexp = c / (c + d),
    RR         = risk_exp / risk_unexp,

    logRR    = log(RR),
    SE_logRR = sqrt(1/a - 1/(a+b) + 1/c - 1/(c+d)),
    lcl      = exp(logRR - 1.96 * SE_logRR),
    ucl      = exp(logRR + 1.96 * SE_logRR)
  ) %>%
  select(
    age_grp,
    est = RR,
    lcl,
    ucl
  )

rr_by_age

```

```{r visualisation_and_output, include=TRUE}
# ======================
# 6) 可视化
# ======================

library(ggplot2)
library(dplyr)

# 6a) 吸烟 vs 10年CHD 风险条形图 
plot_dat <- dat1 %>%
  dplyr::group_by(smoke) %>%
  dplyr::summarise(
    risk = mean(chd == "Yes"),
    .groups = "drop"
  )

# 给柱子上方留空间，但不超过 1
ymax <- min(1, max(plot_dat$risk) + 0.02)

p1 <- ggplot(plot_dat, aes(x = smoke, y = risk)) +
  geom_col() +
  geom_text(
    aes(label = scales::percent(risk, accuracy = 0.1)),
    vjust = -0.3
  ) +
  labs(
    title = "10-year CHD Risk by Smoking",
    x = NULL,
    y = "Risk (Incidence Proportion)"
  ) +
  ylim(0, ymax)

p1

# 6b) 性别分层 RR 森林图
p2 <- ggplot(rr_by_sex, aes(x = sex, y = est)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lcl, ymax = ucl), width = 0.1) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(
    title = "Stratum-specific RR (Smoking → CHD) by Sex",
    x = "Sex",
    y = "Risk Ratio (95% CI)"
  ) +
  coord_flip()

p2

# 6c) 年龄分层 RR 森林图
p3 <- ggplot(rr_by_age, aes(x = age_grp, y = est)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lcl, ymax = ucl), width = 0.1) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(
    title = "Stratum-specific RR (Smoking → CHD) by Age Group",
    x = "Age Group",
    y = "Risk Ratio (95% CI)"
  ) +
  coord_flip()

p3

#保存输出
output_dir <- file.path("..", "output", "plots_1_cohort study")
dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)
timestamp <- format(Sys.time(), "%Y%m%d_%H%M")

ggsave(file.path(output_dir, paste0("plot_risk_by_smoke",timestamp,".png")),    p1, width = 6, height = 4, dpi = 300)
ggsave(file.path(output_dir, paste0("plot_forest_rr_by_sex",timestamp,".png")), p2, width = 6, height = 4, dpi = 300)
ggsave(file.path(output_dir, paste0("plot_forest_rr_by_age",timestamp,".png")), p3, width = 6, height = 4, dpi = 300)


#output_dir <- file.path("..", "output", paste0("run_", format(Sys.time(), "%Y-%m-%d_%H%M")))
#dir.create(output_dir, recursive = TRUE, showWarnings = FALSE)

#ggsave(file.path(output_dir, "plot_risk_by_smoke.png"),    p1, width = 6, height = 4, dpi = 300)
#ggsave(file.path(output_dir, "plot_forest_rr_by_sex.png"), p2, width = 6, height = 4, dpi = 300)
#ggsave(file.path(output_dir, "plot_forest_rr_by_age.png"), p3, width = 6, height = 4, dpi = 300)

```

```{r final result output, include=TRUE}
# ======================
# 7) 导出关键结果
# ======================
output_dir <- file.path("..","output", "final_result_1_cohort_study")
dir.create(output_dir, showWarnings = FALSE)
timestamp <- format(Sys.time(), "%Y%m%d_%H%M")


# 1. 性别分层 RR
readr::write_csv(rr_by_sex,
  file.path(output_dir, paste0("rr_by_sex_", timestamp, ".csv"))
)

# 2. 年龄分层 RR
readr::write_csv(rr_by_age,
  file.path(output_dir, paste0("rr_by_age_", timestamp, ".csv"))
)

# 3. 总体 2×2 表
readr::write_csv(
  as.data.frame.matrix(tab_overall),
  file.path(output_dir, paste0("tab_overall_smoke_chd_", timestamp, ".csv"))
)

# 4. MH analysis confounding evaluation

mh_out <- tibble(
  strata = c("sex","age_grp"),
  MH_common_OR = c(unname(mh_sex$estimate), unname(mh_age$estimate)),
  p_value = c(mh_sex$p.value, mh_age$p.value)
)
readr::write_csv(mh_out, file.path(output_dir, paste0("confounding_evalutation", timestamp, ".csv")))



# 5. multiple interaction and Additive interaction evaluation
# 粗模型（Crude Poisson robust）
readr::write_csv(
  crude_res %>% mutate(measure = "Crude Poisson robust (RR approx)"),
  file.path(output_dir, paste0("reg_crude_poisson_rb_", timestamp, ".csv"))
)

# 调整模型（Adjusted Poisson robust）
readr::write_csv(
  adj_res %>% mutate(measure = "Adj Poisson robust (RR approx)"),
  file.path(output_dir, paste0("reg_adj_poisson_rb_", timestamp, ".csv"))
)

# 含交互项模型（Poisson robust with interaction）
readr::write_csv(int_res %>% mutate(measure = "Poisson robust with interaction"),
  file.path(output_dir, paste0("reg_poisson_interaction_", timestamp, ".csv")))

# additive
readr::write_csv(add_int, file.path(output_dir, paste0("additive_interaction_evaluation", timestamp, ".csv")))

cat("✅ 回归结果已导出到：", normalizePath(output_dir), "\n")

# 简短控制台汇总
cat("\n=== Overall RR (epi.2by2) ===\n"); print(rr_overall)
cat("\n=== Age-adjusted (Poisson robust) RR for smoke ===\n"); print(adj_rr)
cat(sprintf("\nConfounding %% change (Adj vs Crude RR): %.1f%%\n", pct_change))
cat("\n=== Additive interaction (Sex x Smoke) ===\n"); print(add_int)
cat('\n文件与图已导出到 ./outputs/ 目录。\n')
```
