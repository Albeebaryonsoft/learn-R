---
title: "8.Quantitative Bias Analysis and Sensitivity Analysis"
output: html_document
---

required_packages <- c("tidyverse", "broom", "epiR", "epitools", "gtsummary","readr")
for (pkg in required_packages) {
if (!requireNamespace(pkg, quietly = TRUE)) {
install.packages(pkg)
library(pkg, character.only = TRUE)
}
}


dat0 <- readr::read_csv("data/framingham_raw.csv")

dat <- dat0 %>%
  mutate(
    smoke   = factor(currentSmoker, levels = c(0,1), labels = c("No","Yes")),
    chd     = factor(TenYearCHD,     levels = c(0,1), labels = c("No","Yes")),
    sex     = factor(male,           levels = c(0,1), labels = c("Female","Male")),
    diab    = factor(diabetes,       levels = c(0,1), labels = c("No","Yes")),
    hyp     = factor(prevalentHyp,   levels = c(0,1), labels = c("No","Yes")),
    age_grp = cut(age, breaks = c(0,45,60,120), right = FALSE,
    labels = c("[0,45)","[45,60)","[60,+)"))
  )

glimpse(dat)



# 仅保留本分析所需变量的完整观测
vars_use <- c("smoke","chd","sex","diab","hyp","age_grp","age","sysBP","diaBP","totChol","glucose","education","BPMeds","cigsPerDay","BMI","heartRate")
dat1 <- dat %>% select(any_of(vars_use)) %>% drop_na(smoke, chd, sex, age_grp)

# ======================
# 1) 总体 2x2：吸烟 vs 10年CHD
# ======================
tab_overall <- table(dat1$smoke, dat1$chd)
tab_overall

# 风险、RR、RD、OR（基于计数，适合前瞻性队列）
# epiR::epi.2by2 期望矩阵形如：
#      Disease+
# Exp+    a
# Exp-    c   等
# 我们把"Yes"对应阳性
library(epiR)
e_overall <- epiR::epi.2by2(tab_overall,
                            method = "cohort.count",
                            conf.level = 0.95,
                            units = 100,
                            outcome = "as.columns")
e_overall

# 提取主要指标
rr_overall  <- e_overall$massoc$RR.strata.wald[1, c("est","lower","upper")]
rd_overall  <- e_overall$massoc$AR.strata.wald[1, c("est","lower","upper")]
or_overall  <- e_overall$massoc$OR.strata.wald[1, c("est","lower","upper")]

print(rr_overall); print(rd_overall); print(or_overall)

# ======================
# 2) 分层：按性别、年龄组
# ======================
# 2a) 按性别计算分层RR（以及森林图数据）
calc_rr_by_stratum <- function(df, strata_var){
  df %>%
    group_by(.data[[strata_var]]) %>%
    group_modify(~{
      tt <- table(.x$smoke, .x$chd)
      e  <- epiR::epi.2by2(tt, method = "cohort.count", conf.level = 0.95,
                           units = 100, outcome = "as.columns")
      tibble(
        est = e$massoc$RR.strata.wald[1,"est"],
        lcl = e$massoc$RR.strata.wald[1,"lower"],
        ucl = e$massoc$RR.strata.wald[1,"upper"],
        n   = nrow(.x)
      )
    }) %>%
    rename(stratum = !!strata_var)
}

rr_by_sex <- calc_rr_by_stratum(dat1, "sex")
rr_by_age <- calc_rr_by_stratum(dat1, "age_grp")
rr_by_sex
rr_by_age

# 2b) Mantel–Haenszel（以性别为层）：MH 合并 OR（经典做法）
# 注意：mantelhaen.test 得到的是共同比值比（OR），不是RR
tab_3d_sex <- xtabs(~ smoke + chd + sex, data = dat1)
mh_sex <- mantelhaen.test(tab_3d_sex)  # common OR
mh_sex

# 2c) Mantel–Haenszel（以年龄组为层）
tab_3d_age <- xtabs(~ smoke + chd + age_grp, data = dat1)
mh_age <- mantelhaen.test(tab_3d_age)
mh_age

# ======================
# 3) 混杂评估（以年龄为潜在混杂）：粗略RR vs 分层合并（用log-binomial失败时用Poisson稳健代替）
# ======================
# 3a) 粗略 RR（用Poisson稳健近似风险比）
library(sandwich); library(lmtest); library(broom)
fit_crude <- glm(as.numeric(chd) - 1 ~ smoke, family = poisson(link="log"), data = dat1)
vc_crude  <- sandwich::vcovHC(fit_crude, type = "HC0")
crude_res <- lmtest::coeftest(fit_crude, vcov. = vc_crude) %>% broom::tidy() %>%
  mutate(RR = exp(estimate), lcl = exp(estimate - 1.96*std.error), ucl = exp(estimate + 1.96*std.error))
crude_rr <- crude_res %>% filter(term=="smokeYes") %>% select(RR, lcl, ucl)
crude_rr

# 3b) 调整年龄、糖尿病、高血压的RR（Poisson稳健）
fit_adj <- glm(as.numeric(chd) - 1 ~ smoke + age_grp + diab + hyp, family = poisson(link="log"), data = dat1)
vc_adj  <- sandwich::vcovHC(fit_adj, type = "HC0")
adj_res <- lmtest::coeftest(fit_adj, vcov. = vc_adj) %>% broom::tidy() %>%
  mutate(RR = exp(estimate), lcl = exp(estimate - 1.96*std.error), ucl = exp(estimate + 1.96*std.error))
adj_rr <- adj_res %>% filter(term=="smokeYes") %>% select(RR, lcl, ucl)
adj_rr

# 混杂相对变化（%）
pct_change <- (adj_rr$RR - crude_rr$RR)/crude_rr$RR * 100
pct_change

# ======================
# 4) 交互（效应修饰）：吸烟*性别（乘性 & 加性）
# ======================
# 4a) 乘性交互：在Poisson稳健模型里加入交互项，看交互项是否显著
fit_int <- glm(as.numeric(chd) - 1 ~ smoke*sex + age_grp + diab + hyp,
               family = poisson(link="log"), data = dat1)
vc_int  <- sandwich::vcovHC(fit_int, type = "HC0")
int_res <- lmtest::coeftest(fit_int, vcov. = vc_int) %>% broom::tidy() %>%
  mutate(RR = exp(estimate), lcl = exp(estimate - 1.96*std.error), ucl = exp(estimate + 1.96*std.error))
int_res %>% filter(str_detect(term,"smokeYes:sexMale|smokeYes:sexMale"))

# 4b) 加性交互：RERI / AP / S（基于分层风险）
risk_cell <- dat1 %>%
  group_by(sex, smoke) %>%
  summarise(n = n(), cases = sum(chd=="Yes"), risk = cases/n, .groups="drop") %>%
  tidyr::pivot_wider(names_from = c(sex, smoke), values_from = risk)
# 风险命名：R00 = Female,No；R10 = Female,Yes；R01 = Male,No；R11 = Male,Yes
R00 <- risk_cell$Female_No; R10 <- risk_cell$Female_Yes
R01 <- risk_cell$Male_No;   R11 <- risk_cell$Male_Yes

RERI <- as.numeric(R11 - R10 - R01 + R00)
AP   <- as.numeric(RERI / R11)
S    <- as.numeric((R11 - R00) / ((R10 - R00) + (R01 - R00)))

add_int <- tibble(metric=c("RERI","AP","S"), value=c(RERI, AP, S))
add_int

# ======================
# 5) 描述性表：按吸烟分组
# ======================
library(gtsummary)
desc_tbl <- dat1 %>%
  select(smoke, sex, age, age_grp, diab, hyp, sysBP, diaBP, totChol, glucose, BMI, cigsPerDay) %>%
  tbl_summary(by = smoke,
              type = list(age ~ "continuous", sysBP ~ "continuous", diaBP ~ "continuous",
                          totChol ~ "continuous", glucose ~ "continuous", BMI ~ "continuous", cigsPerDay ~ "continuous"),
              statistic = all_continuous() ~ "{mean} ({sd})",
              missing = "ifany") %>%
  add_p() %>%
  modify_header(label ~ "**Variable**") %>%
  bold_labels()
desc_tbl

# ======================
# 6) 可视化
# ======================
library(ggplot2)
# 6a) 吸烟 vs 10年CHD 风险条形图
p1 <- dat1 %>%
  group_by(smoke) %>%
  summarise(risk = mean(chd=="Yes")) %>%
  ggplot(aes(smoke, risk)) +
  geom_col() +
  geom_text(aes(label = scales::percent(risk, accuracy = 0.1)), vjust = -0.3) +
  labs(title = "10-year CHD Risk by Smoking", x = NULL, y = "Risk (Incidence Proportion)") +
  ylim(0, max(0.02 + max(..y..), 1))

# 6b) 性别分层 RR 森林图
p2 <- rr_by_sex %>%
  ggplot(aes(x = stratum, y = est)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lcl, ymax = ucl), width = 0.1) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(title = "Stratum-specific RR (Smoking → CHD) by Sex",
       x = "Sex", y = "Risk Ratio (95% CI)")

# 6c) 年龄分层 RR 森林图
p3 <- rr_by_age %>%
  ggplot(aes(x = stratum, y = est)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = lcl, ymax = ucl), width = 0.1) +
  geom_hline(yintercept = 1, linetype = 2) +
  labs(title = "Stratum-specific RR (Smoking → CHD) by Age Group",
       x = "Age Group", y = "Risk Ratio (95% CI)")

# 保存图形与导出结果
dir.create("outputs", showWarnings = FALSE)
ggsave("outputs/plot_risk_by_smoke.png", p1, width = 6, height = 4, dpi = 300)
ggsave("outputs/plot_forest_rr_by_sex.png", p2, width = 6, height = 4, dpi = 300)
ggsave("outputs/plot_forest_rr_by_age.png", p3, width = 6, height = 4, dpi = 300)

# ======================
# 7) 导出关键结果
# ======================
readr::write_csv(as.data.frame.matrix(tab_overall), "outputs/tab_overall_smoke_chd.csv")
readr::write_csv(rr_by_sex, "outputs/rr_by_sex.csv")
readr::write_csv(rr_by_age, "outputs/rr_by_age.csv")

mh_out <- tibble(
  strata = c("sex","age_grp"),
  MH_common_OR = c(unname(mh_sex$estimate), unname(mh_age$estimate)),
  p_value = c(mh_sex$p.value, mh_age$p.value)
)
readr::write_csv(mh_out, "outputs/mh_common_or.csv")

readr::write_csv(add_int, "outputs/interaction_additive_sex_smoke.csv")

# 回归结果导出
readr::write_csv(crude_res %>% mutate(measure="Crude Poisson robust (RR approx)"),
                 "outputs/reg_crude_poisson_rb.csv")
readr::write_csv(adj_res %>% mutate(measure="Adj Poisson robust (RR approx)"),
                 "outputs/reg_adj_poisson_rb.csv")
readr::write_csv(int_res %>% mutate(measure="Poisson robust with interaction"),
                 "outputs/reg_poisson_interaction.csv")

# 简短控制台汇总
cat("\n=== Overall RR (epi.2by2) ===\n"); print(rr_overall)
cat("\n=== Age-adjusted (Poisson robust) RR for smoke ===\n"); print(adj_rr)
cat(sprintf("\nConfounding %% change (Adj vs Crude RR): %.1f%%\n", pct_change))
cat("\n=== Additive interaction (Sex x Smoke) ===\n"); print(add_int)
cat('\n文件与图已导出到 ./outputs/ 目录。\n')
